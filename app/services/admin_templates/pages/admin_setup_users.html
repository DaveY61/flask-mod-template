{% extends 'layouts/main.html' %}
{% block title %}User Setup {{ config.PROJECT_NAME }}{% endblock %}
{% block content %}

<div class="page-header">
  <h2>User Setup</h2>
</div>

<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header" id="accessOptionsHeader" data-bs-toggle="collapse" data-bs-target="#accessOptionsCollapse" aria-expanded="false" aria-controls="accessOptionsCollapse">
        <h6 class="mb-0">
          <span class="collapse-icon" style="display: inline-block; width: 10px; text-align: center;">+</span>
          Access Options
        </h6>
      </div>
      <div id="accessOptionsCollapse" class="collapse" aria-labelledby="accessOptionsHeader">
        <div class="card-body">
          <form method="POST" id="access-options-form">
            <input type="hidden" name="action" value="update_access_options">
            <div class="gui-setup-container">
              <div class="gui-setup-row">
                <label for="disable_self_registration" class="gui-label">Disable Self Registration:</label>
                <div class="gui-input">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="disable_self_registration" name="disable_self_registration" {% if config.DISABLE_SELF_REGISTRATION %}checked{% endif %}>
                  </div>
                </div>
              </div>
              <div class="gui-setup-row">
                <label for="require_login_for_site_access" class="gui-label">Require Login for Site Access:</label>
                <div class="gui-input">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="require_login_for_site_access" name="require_login_for_site_access" {% if config.REQUIRE_LOGIN_FOR_SITE_ACCESS %}checked{% endif %}>
                  </div>
                </div>
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3 btn-sm">Update Config</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="table-responsive">
      <table id="user-table" class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Active</th>
            <th>Admin</th>
            <th>Role</th>
            <th>Created At</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
            <tr>
              <td>{{ user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ 'Yes' if user.is_active else 'No' }}</td>
              <td>{{ 'Yes' if user.is_admin else 'No' }}</td>
              <td>
                <form method="POST" class="update-role-form">
                  <input type="hidden" name="action" value="update_role">
                  <input type="hidden" name="user_id" value="{{ user.id }}">
                  <select name="user_role" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">No Role</option>
                    {% for role in roles %}
                      <option value="{{ role.name }}" {% if user.user_role == role.name %}selected{% endif %}>{{ role.name }}</option>
                    {% endfor %}
                  </select>
                </form>
              </td>
              <td>{{ user.created_at }}</td>
              <td>
                <form method="POST" style="display: inline;">
                  <input type="hidden" name="action" value="delete_user">
                  <input type="hidden" name="user_id" value="{{ user.id }}">
                  <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this user?')">Delete</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='libs/datatables/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='libs/datatables/dataTables.bootstrap5.min.js') }}"></script>
<script>
$(document).ready(function() {
    $('#user-table').DataTable({
        "pageLength": 25,
        "order": [[ 5, "desc" ]],
        "columnDefs": [
            { "orderable": false, "targets": 6 }
        ],
        "stripeClasses": [],
        "hover": true
    });

    $('#accessOptionsHeader').on('click', function() {
      $(this).find('.collapse-icon').text(function(_, text) {
        return text === '+' ? '-' : '+';
      });
    });
});

function showAdminSetup(setupType) {
    window.location.href = "{{ url_for('admin.setup_type', setup_type='') }}" + setupType;
}
</script>
{% endblock %}

{% block additional_styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='libs/datatables/dataTables.bootstrap5.min.css') }}">
<style>
    .table {
        background-color: transparent;
    }
    .table > thead {
        background-color: #f8f9fa;
    }
    .table > tbody > tr {
        background-color: #ffffff;
    }
    .table-hover > tbody > tr:hover {
        background-color: #f8f9fa;
    }
    .form-select-sm {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
        padding-left: 0.5rem;
        font-size: 0.875rem;
    }
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .gui-setup-container {
      display: table;
      width: 100%;
    }
    .gui-setup-row {
      display: table-row;
    }
    .gui-label {
      display: table-cell;
      white-space: nowrap;
      padding-right: 10px;
      padding-bottom: 15px;
      vertical-align: middle;
    }
    .gui-input {
      display: table-cell;
      width: 100%;
      padding-bottom: 15px;
    }
    .form-check-input {
      width: 3em;
      height: 1.5em;
    }
    #accessOptionsHeader {
      cursor: pointer;
    }
    .collapse-icon {
      margin-right: 10px;
    }
</style>
{% endblock %}