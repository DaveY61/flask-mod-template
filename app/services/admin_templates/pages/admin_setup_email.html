{% extends 'layouts/main.html' %}
{% block title %}Email Setup {{ config.PROJECT_NAME }}{% endblock %}
{% block content %}

<div class="page-header">
  <h2>Email Setup</h2>
</div>

<form method="POST" id="email-setup-form" class="col-md-8" data-env-file-exists="{{ env_file_exists|tojson }}">
  <div class="gui-setup-container">
    <div class="gui-setup-row">
      <label for="email_from_address" class="gui-label">From Email Address:</label>
      <div class="gui-input">
        <input type="email" class="form-control form-control-sm" id="email_from_address" name="email_from_address" value="{{ email_config['EMAIL_FROM_ADDRESS'] }}" required>
      </div>
    </div>
    <div class="gui-setup-row">
      <label for="smtp_server" class="gui-label">SMTP Server:</label>
      <div class="gui-input">
        <input type="text" class="form-control form-control-sm" id="smtp_server" name="smtp_server" value="{{ email_config['SMTP_SERVER'] }}" required>
      </div>
    </div>
    <div class="gui-setup-row">
      <label for="smtp_port" class="gui-label">SMTP Port:</label>
      <div class="gui-input">
        <input type="number" class="form-control form-control-sm" id="smtp_port" name="smtp_port" value="{{ email_config['SMTP_PORT'] }}" required>
      </div>
    </div>
    <div class="gui-setup-row">
      <label for="smtp_username" class="gui-label">SMTP Username:</label>
      <div class="gui-input">
        <input type="text" class="form-control form-control-sm" id="smtp_username" name="smtp_username" value="{{ email_config['SMTP_USERNAME'] }}" required>
      </div>
    </div>
    <div class="gui-setup-row">
      <label for="smtp_password" class="gui-label">SMTP Password:</label>
      <div class="gui-input">
        <input type="password" class="form-control form-control-sm" id="smtp_password" name="smtp_password" value="{{ email_config['SMTP_PASSWORD'] }}" required>
      </div>
    </div>
    <div class="gui-setup-row">
      <label for="test_email" class="gui-label">Test Email Address:</label>
      <div class="gui-input">
        <input type="email" class="form-control form-control-sm" id="test_email" name="test_email" value="{{ test_email }}" required>
      </div>
    </div>
  </div>
  <div class="mt-3 d-flex align-items-center">
    <button type="button" id="testEmailBtn" class="btn btn-success btn-sm me-2">Test Email</button>
    <button type="button" id="updateSessionBtn" class="btn btn-primary btn-sm me-2" disabled>Update Session</button>
    <div class="d-flex align-items-center">
      <button type="button" id="saveSettingsBtn" class="btn btn-warning btn-sm me-1" disabled>Save Settings</button>
      <i id="saveSettingsAlert" class="fas fa-exclamation-circle text-warning" style="cursor: pointer; display: none;"></i>
    </div>
  </div>
  
<!-- Modal for Save Settings Warning -->
<div class="modal fade" id="saveSettingsModal" tabindex="-1" aria-labelledby="saveSettingsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content save-settings-warning">
      <div class="modal-header">
        <h5 class="modal-title" id="saveSettingsModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Save Settings Warning
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>The "Save Setting" operation is not supported (no .env file).</p>
        <p>Be sure to update your server environment with any changes.</p>
        <p><strong>Updates to the session will be lost if the server restarts.</strong></p>
      </div>
    </div>
  </div>
</div>
</form>

{% endblock %}

{% block scripts %}
<script>
function showAdminSetup(setupType) {
    window.location.href = "{{ url_for('admin.setup_type', setup_type='') }}" + setupType;
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('email-setup-form');
    const testEmailBtn = document.getElementById('testEmailBtn');
    const updateSessionBtn = document.getElementById('updateSessionBtn');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const saveSettingsAlert = document.getElementById('saveSettingsAlert');
    const envFileExists = JSON.parse(form.dataset.envFileExists);

    let originalFormData = new FormData(form);
    let sessionData = new FormData(form);
    let isUpdatingSession = false;

    // Initialize sessionData with the current form values
    for (let input of form.elements) {
        if (input.name) {
            sessionData.set(input.name, input.value);
        }
    }

    function formDataChanged() {
        const currentFormData = new FormData(form);
        return ![...originalFormData.entries()].every(([key, value]) => 
            currentFormData.get(key) === value
        );
    }

    function sessionDataChanged() {
        const currentFormData = new FormData(form);
        return ![...sessionData.entries()].every(([key, value]) => 
            currentFormData.get(key) === value
        );
    }

    function updateButtonStates() {
        updateSessionBtn.disabled = !formDataChanged();
        if (envFileExists) {
            saveSettingsBtn.disabled = !sessionDataChanged();
            saveSettingsBtn.classList.remove('btn-outline-secondary');
            saveSettingsBtn.classList.add('btn-warning');
            saveSettingsAlert.style.display = 'none';
        } else {
            saveSettingsBtn.disabled = true;
            saveSettingsBtn.classList.remove('btn-warning');
            saveSettingsBtn.classList.add('btn-outline-secondary');
            saveSettingsAlert.style.display = 'inline-block';
        }
    }

    form.addEventListener('input', updateButtonStates);

    testEmailBtn.addEventListener('click', function() {
        form.action.value = 'test_email';
        form.submit();
    });

    updateSessionBtn.addEventListener('click', function() {
        isUpdatingSession = true;
        form.action.value = 'update_session';
        form.submit();
    });

    saveSettingsBtn.addEventListener('click', function() {
        form.action.value = 'save_settings';
        form.submit();
    });

    saveSettingsAlert.addEventListener('click', function() {
        $('#saveSettingsModal').modal('show');
    });

    window.addEventListener('beforeunload', function (e) {
        if (formDataChanged() && !isUpdatingSession) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    updateButtonStates();
});
</script>
{% endblock %}

{% block additional_styles %}
{{ super() }}
<style>
  .gui-setup-container {
    display: table;
    width: 100%;
  }
  .gui-setup-row {
    display: table-row;
  }
  .gui-label {
    display: table-cell;
    white-space: nowrap;
    padding-right: 10px;
    padding-bottom: 15px;
    vertical-align: middle;
  }
  .gui-input {
    display: table-cell;
    width: 100%;
    padding-bottom: 15px;
  }
  .gui-input input[type="text"],
  .gui-input input[type="email"],
  .gui-input input[type="number"],
  .gui-input input[type="password"] {
    width: 250px;
  }

  .save-settings-warning {
    border: 2px solid red;
  }

  .save-settings-warning .modal-header {
    background-color: #fff3cd;
    color: red;
    border-bottom: 1px solid #ffeeba;
  }

  .save-settings-warning .modal-body {
    background-color: #fff3cd;
    color: red;
  }

  .save-settings-warning .modal-title {
    display: flex;
    align-items: center;
  }

  .save-settings-warning .btn-close {
    color: #856404;
  }

  #saveSettingsAlert {
    font-size: 1.2em;
    margin-left: 5px;
    color: #ffc107;
  }

  #saveSettingsBtn:disabled {
    opacity: 0.5;
  }
  </style>
{% endblock %}