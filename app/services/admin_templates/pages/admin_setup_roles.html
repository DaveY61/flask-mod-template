{% extends 'layouts/main.html' %}
{% block title %}Roles Setup {{ config.PROJECT_NAME }}{% endblock %}
{% block content %}

<div class="page-header">
  <h1>Roles Setup</h1>
</div>

<div class="row">
  <div class="col-md-4">
    <div class="add-role-form" style="max-width: calc(40ch + 40px); margin: 0 auto;">
      <h3>Add New Role</h3>
      <form method="POST" id="add-role-form">
        <input type="hidden" name="action" value="add_role">
        <div class="mb-3">
          <label for="role_name" class="form-label">Role Name</label>
          <input type="text" class="form-control" id="role_name" name="role_name" maxlength="15" required style="width: 15ch;">
        </div>
        <div class="mb-3">
          <label for="role_description" class="form-label">Role Description</label>
          <input type="text" class="form-control" id="role_description" name="role_description" maxlength="40" required style="width: 40ch;">
        </div>
        <div class="mb-3">
          <label class="form-label">Associated Modules</label>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="all_modules" name="all_modules">
            <label class="form-check-label" for="all_modules">
              All Modules
            </label>
          </div>
          <div class="module-checkboxes" style="max-height: 200px; overflow-y: auto;">
            {% for module in modules %}
              <div class="form-check">
                <input class="form-check-input module-checkbox" type="checkbox" name="modules" value="{{ module.name }}" id="module_{{ loop.index }}">
                <label class="form-check-label {% if module.enabled %}text-success{% else %}text-muted{% endif %}" for="module_{{ loop.index }}">
                  {{ module.menu_name }}
                </label>
              </div>
            {% endfor %}
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Role</button>
      </form>
    </div>
  </div>
  
  <div class="col-md-8">
    <h3>Existing Roles</h3>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th style="white-space: nowrap;">Role Name</th>
            <th>Description</th>
            <th>Associated Modules</th>
            <th>Users</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for role in roles %}
            <tr>
              <td style="white-space: nowrap;">{{ role.name }}</td>
              <td>
                <form method="POST" class="edit-description-form">
                  <input type="hidden" name="action" value="edit_description">
                  <input type="hidden" name="role_name" value="{{ role.name }}">
                  <div class="input-group">
                    <input type="text" class="form-control" name="role_description" value="{{ role.description }}" maxlength="40">
                    <button type="submit" class="btn btn-outline-secondary">Update</button>
                  </div>
                </form>
              </td>
              <td>
                <form method="POST" class="update-modules-form">
                  <input type="hidden" name="action" value="update_modules">
                  <input type="hidden" name="role_name" value="{{ role.name }}">
                  <div style="max-height: 150px; overflow-y: auto;">
                    {% for module in modules %}
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="modules" value="{{ module.name }}" id="module_{{ role.name }}_{{ loop.index }}"
                               {% if module.name in role.modules %}checked{% endif %}>
                        <label class="form-check-label {% if module.enabled %}text-success{% else %}text-muted{% endif %}" for="module_{{ role.name }}_{{ loop.index }}">
                          {{ module.menu_name }}
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm mt-2">Update Modules</button>
                </form>
              </td>
              <td>
                {{ role.users_count }}
              </td>
              <td>
                <form method="POST" style="display: inline;">
                  <input type="hidden" name="action" value="delete_role">
                  <input type="hidden" name="role_name" value="{{ role.name }}">
                  <div class="d-flex align-items-center">
                    <button type="submit" class="btn btn-danger btn-sm me-2" 
                            {% if role.users_count > 0 %}disabled{% endif %}>
                      Delete
                    </button>
                    {% if role.users_count > 0 %}
                      <i class="fas fa-exclamation-circle text-warning" 
                         data-bs-toggle="tooltip" 
                         data-bs-placement="top" 
                         title="Cannot delete role while it's in use ({{ role.users_count }} user{{ 's' if role.users_count != 1 else '' }})"></i>
                    {% endif %}
                  </div>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<input type="hidden" id="existing-role-names" data-roles='{{ roles|map(attribute="name")|list|tojson }}'>

<script>
function showAdminSetup(setupType) {
    window.location.href = "{{ url_for('admin.setup_type', setup_type='') }}" + setupType;
}

document.addEventListener('DOMContentLoaded', function() {
    const allModulesCheckbox = document.getElementById('all_modules');
    const moduleCheckboxes = document.querySelectorAll('.module-checkbox');

    allModulesCheckbox.addEventListener('change', function() {
        moduleCheckboxes.forEach(checkbox => {
            checkbox.checked = allModulesCheckbox.checked;
        });
    });

    // Add client-side validation for duplicate role names
    const addRoleForm = document.getElementById('add-role-form');
    const roleNameInput = document.getElementById('role_name');
    const existingRoleNamesElement = document.getElementById('existing-role-names');
    const existingRoleNames = JSON.parse(existingRoleNamesElement.dataset.roles);

    addRoleForm.addEventListener('submit', function(event) {
        const newRoleName = roleNameInput.value.trim().toLowerCase();
        const isDuplicate = existingRoleNames.some(roleName => 
            roleName.toLowerCase() === newRoleName
        );

        if (isDuplicate) {
            event.preventDefault();
            alert('A role with this name already exists. Please choose a different name.');
        }
    });
});
</script>
{% endblock %}

{% block additional_styles %}
{{ super() }}
<style>
    .fa-exclamation-circle {
        font-size: 1.2em;
        cursor: help;
    }
    .tooltip-inner {
        background-color: #f8f9fa;
        color: #212529;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}